# КВАС ЛАЙТ — Надёжная защита ваших подключений

**КВАС ЛАЙТ** — это облегчённая версия [оригинального проекта КВАС](https://github.com/qzeleza/kvas), основанная на версии 1.1.9-2. Он предназначен для маршрутизаторов Keenetic с установленной системой пакетов **Entware** и предоставляет гибкую маршрутизацию трафика через защищенное соединение с использованием современных инструментов, таких как **ipset**, **dnsmasq**, **dnscrypt-proxy2** или **AdGuardHome**.

> [!IMPORTANT]  
Проект предназначен для **научно-технических целей**: тестирование сетевых конфигураций, повышение устойчивости и конфиденциальности соединений. Пользователи обязаны соблюдать законодательство своей страны. **Автор не несёт ответственности за неправомерное использование.**

> [!WARNING]  
> **Вы используете этот проект на свой страх и риск!**  
> Автор не несёт ответственности за возможные проблемы с оборудованием, программным обеспечением, доступом к сети или другие последствия.  
> Предполагается, что вы понимаете, что делаете, и осознаёте риски.

## Основные особенности

- **Полный рефакторинг кода**:  
  - Устранён дублирующий код.  
  - Оптимизирована логика работы с правилами **iptables**.  
  - Удалены неиспользуемые функции.  
- **Модульная архитектура**:  
  - Поддержка протоколов защиты трафика **Shadowsocks** и **VLESS**, а в будущем — **AmneziaWG** вынесена в отдельные плагины. Смотрите репозитории [kvl-plugin-*](https://github.com/carIod?tab=repositories).  
- **Изменённая логика работы защиты трафика**:
  - Сайты из защищенного списка **не передаются без защиты** при утере безопасного подключения — они просто перестают открываться.
  - Максимально минимизирована передача защищённых пакетов через обычное подключение, хотя из-за особенностей работы роутеров (очистка и восстановление правил iptables самим роутером) в течение нескольких миллисекунд пакеты могут уходить без защиты.
- **Гибкая маршрутизация DNS**:  
  - Поддержка связки **ipset** с одним из вариантов DNS-серверов:  
    - **dnsmasq** (с поддержкой wildcard) + **dnscrypt-proxy2** (устанавливается по умолчанию).  
    - **AdGuardHome** (включает шифрование DNS-трафика и блокировку рекламы).  
  - Благодаря поддержке **wildcard** в dnsmasq, достаточно добавить домен (например, `domen.com`), чтобы маршрутизация работала для всех поддоменов (`sub1.domen.com`, `sub.sub.domen.com` и т.д.).  

## Требования и подготовка Keenetic

Для работы **КВАС ЛАЙТ** необходимо подготовить маршрутизатор Keenetic. Следуйте этим шагам:

### 1. Установка Entware
- Установите систему пакетов **Entware** на маршрутизатор:  
  - [На встроенную память роутера](https://help.keenetic.com/hc/ru/articles/360021888880).
    
    > Установка Entware на встроенную память **не рекомендуется**, так как частые обращения к памяти могут привести к её износу.

  - [На USB-накопитель](https://help.keenetic.com/hc/ru/articles/360021214160) (рекомендуемый вариант).

### 2. Настройка политик
- Убедитесь, что ваши клиенты используют **"Политику по умолчанию"** в разделе **Интернет -> Приоритеты подключений -> Применение политик** (доступно по адресу `http://<IP_роутера>/controlPanel/policies`).

### 3. Отключение сторонних фильтров
- В разделе **Интернет-фильтры** отключите все сторонние DNS-фильтры (например, NextDNS, SkyDNS, Яндекс DNS).

### 4. Отключение IPv6
- Если используется проводное подключение с поддержкой IPv6, отключите его в настройках подключения.

### 5. Установка компонентов (для прошивок до 3.9.X)
- Если у вас прошивка Keenetic версии **3.8.X или ниже**, установите следующие компоненты через меню **Общие настройки -> Изменить набор компонентов**:  
  - **Модули ядра подсистемы Netfilter**.  
  - **Пакет расширения Xtables-addons для Netfilter**.  

  > Если указанные компоненты отсутствуют, сначала установите **Протокол IPv6**, после чего компоненты Netfilter станут доступны.  

- Для прошивок **3.9.X и выше** этот шаг можно пропустить.

### 6. Доступ к среде Entware
- Все команды выполняются в среде **Entware**, а не в CLI роутера. Подключиться можно одним из следующих способов:  
  - **Через Telnet**:  
    ```bash
    telnet 192.168.1.1
    exec sh
    ```
  - **Через SSH**:
    ```bash
    ssh 192.168.1.1 -l root -p 222
    ```
    Логин: root, пароль по умолчанию: keenetic, порт: 22 или 222.
    
  - **Для Windows: Используйте утилиту [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html) для удобного подключения.**

## Установка КВАС ЛАЙТ

### 1. Подключитесь к среде Entware и выполните команду для установки:
```bash
opkg install curl && curl -sOfL https://cariod.github.io/kvl/install && sh install
```
Следуйте инструкциям, отображаемым на экране.

### 2. Настройка DNS

- **Переключите DNS-сервер с помощью команды:**
  ```bash
  kvl dns mode
  ```

- Если используется встроенный DNS-сервер роутера, программа предложит отключить его (в ручном или автоматическом режиме).
  - После отключения встроенного DNS связь может временно пропасть — это нормально. Повторно выполните `kvl dns mode` для выбора DNS-сервера.

- Рекомендация: Начните с связки dnsmasq + dnscrypt-proxy2 (установлена по умолчанию).
- **Для AdGuardHome**:
  - При выборе AdGuardHome пакет будет автоматически загружен и установлен.
  - Настройте AdGuardHome через временный веб-интерфейс роутера, затем снова выполните `kvl dns mode` для активации.

### 3. Настройка канала
- Убедитесь, что во вкладке **Другие подключения** уже настроено подключение и в его настройках не отмечена опция "Использовать для входа в Интернет".

- Выберите рабочее соединение с помощью команды:
  ```bash
  kvl vpn set
  ```

### 4. Управление списком маршрутизации

- Добавление домена или IP в список:
  ```bash
  kvl list add <имя_хоста_или_IP>
  ```
- Удаление из списка:
  ```bash
  kvl list del <имя_хоста_или_IP>
  ```
- Поддерживаются доменные имена, конкретные IP-адреса или подсети.

## Полезные команды и советы

### Оптимизация DNS-серверов
- Команда для проверки доступности DNS-резолверов:
  ```bash
  kvl dns test
  ```
  - Запускает временный экземпляр dnscrypt-proxy2 и тестирует доступность серверов.
    - Выводит списком серверов с наименьшей задержкой, включающую:
      - Имя сервера.
      - Время отклика (пинг).
      - Страну расположения.
      - Поддерживаемые протоколы.
  - Выберите нужные Вам серверы по номерам строк через запятую, рекомендуется 5-15:
    - Для dnscrypt-proxy2: Программа автоматически настроит использование выбранных серверов.
    - Для AdGuardHome: Получите список серверов для вставки в веб-интерфейс AdGuardHome.

## Лицензия
- Проект распространяется под лицензией Apache 2.0. Часть кода согласно лицензии заимствована из оригинального проекта [КВАС](https://github.com/qzeleza/kvas).

## Поддержка и обратная связь

Если у вас есть вопросы или предложения, создайте [issue](https://github.com/carIod/kvl/issues) в репозитории проекта
